#!/bin/bash

set -e

# === 1. –ó–∞–ø—Ä–æ—Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –í–ú ===
read -p "–°–∫–æ–ª—å–∫–æ –í–ú –±—É–¥—É—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Ç–µ—Å—Ç–µ? (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1, 2, 4): " VM_COUNT
if ! [[ "$VM_COUNT" =~ ^[1-9][0-9]*$ ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –≤–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ ‚â• 1"
    exit 1
fi

# === 2. –ó–∞–ø—Ä–æ—Å IP-–∞–¥—Ä–µ—Å–æ–≤ ===
declare -a VMS
for ((i=1; i<=VM_COUNT; i++)); do
    read -p "–í–≤–µ–¥–∏—Ç–µ IP-–∞–¥—Ä–µ—Å –í–ú #$i: " ip
    if [[ ! $ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π IP: $ip"
        exit 1
    fi
    VMS+=("$ip")
done

# === 3. –ó–∞–ø—Ä–æ—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ fio (–æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –≤—Å–µ—Ö) ===
echo -e "\n=== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ fio-—Ç–µ—Å—Ç–∞ (–µ–¥–∏–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤—Å–µ—Ö –í–ú) ==="
read -p "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: cluster_run): " TEST_NAME
TEST_NAME="${TEST_NAME:-cluster_run}"

read -p "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10G): " SIZE
SIZE="${SIZE:-10G}"

read -p "–†–∞–∑–º–µ—Ä –±–ª–æ–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 4k): " BS
BS="${BS:-4k}"

read -p "–ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø–∏—Å–∏ –≤ RW (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 60): " MIX
MIX="${MIX:-60}"

read -p "–ì–ª—É–±–∏–Ω–∞ –æ—á–µ—Ä–µ–¥–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 64): " IO_DEPTH
IO_DEPTH="${IO_DEPTH:-64}"

read -p "–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (—Å–µ–∫, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 60): " RUNTIME
RUNTIME="${RUNTIME:-60}"

USER="testuser"  # ‚Üê –∑–∞–º–µ–Ω–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
REMOTE_DIR="/home/$USER"

# === 4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã ===
CMD="cd $REMOTE_DIR && python3 ./test_fio_5.py \
  --test-name '$TEST_NAME' \
  --size '$SIZE' \
  --bs '$BS' \
  --mix '$MIX' \
  --io-depth $IO_DEPTH \
  --runtime $RUNTIME"

echo -e "\n‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –Ω–∞ ${#VMS[@]} –í–ú..."
echo "   –¢–µ—Å—Ç: $TEST_NAME | –í—Ä–µ–º—è: ${RUNTIME} —Å–µ–∫"

# === 5. –ó–∞–ø—É—Å–∫ –Ω–∞ –≤—Å–µ—Ö –í–ú –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ ===
for ip in "${VMS[@]}"; do
    echo "üöÄ –ó–∞–ø—É—Å–∫ –Ω–∞ $ip..."
    ssh "$USER@$ip" "$CMD" > "fio_log_$ip.log" 2>&1 &
done

wait
echo -e "\n‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã."

# === 6. –°–±–æ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ===
RESULTS_LOCAL="fio_results_$(date +%Y%m%d_%H%M)"
mkdir -p "$RESULTS_LOCAL"

for ip in "${VMS[@]}"; do
    echo "‚¨áÔ∏è –°–±–æ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å $ip..."
    scp -r "$USER@$ip:$REMOTE_DIR/results/" "$RESULTS_LOCAL/results_$ip/" 2>/dev/null || {
        echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å $ip"
    }
done

echo -e "\nüìÅ –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: ./$RESULTS_LOCAL/"
ls -l "$RESULTS_LOCAL"