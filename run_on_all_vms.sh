#!/bin/bash

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
VMS=("10.85.105.181" "10.85.105.182" "10.85.105.183" "10.85.105.184")  # IP –∞–¥—Ä–µ—Å–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –º–∞—à–∏–Ω
USER="test"
REMOTE_DIR="/home/$USER"
SCRIPT_NAME="test_fio_7.py"

# === –ó–∞–ø—Ä–æ—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –æ–¥–∏–Ω —Ä–∞–∑ ===
echo "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ fio-—Ç–µ—Å—Ç–∞ –¥–ª—è –≤—Å–µ—Ö –í–ú ==="
read -p "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: cluster_run): " TEST_NAME
TEST_NAME="${TEST_NAME:-cluster_run}"

read -p "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10G): " SIZE
SIZE="${SIZE:-10G}"

read -p "–†–∞–∑–º–µ—Ä –±–ª–æ–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 4k): " BS
BS="${BS:-4k}"

read -p "–ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø–∏—Å–∏ –≤ RW (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 60): " MIX
MIX="${MIX:-60}"

read -p "–ì–ª—É–±–∏–Ω–∞ –æ—á–µ—Ä–µ–¥–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 64): " IO_DEPTH
IO_DEPTH="${IO_DEPTH:-64}"

read -p "–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (—Å–µ–∫, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 60): " RUNTIME
RUNTIME="${RUNTIME:-60}"

# === –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã ===
CMD="cd $REMOTE_DIR && python3 ./$SCRIPT_NAME \
  --test-name '$TEST_NAME' \
  --size '$SIZE' \
  --bs '$BS' \
  --mix '$MIX' \
  --io-depth $IO_DEPTH \
  --runtime $RUNTIME"

echo -e "\n‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –Ω–∞ ${#VMS[@]} –í–ú —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:"
echo "   –¢–µ—Å—Ç: $TEST_NAME"
echo "   –í—Ä–µ–º—è: ${RUNTIME} —Å–µ–∫"
echo "   –ë–ª–æ–∫: $BS, –ó–∞–ø–∏—Å—å: ${MIX}%, –û—á–µ—Ä–µ–¥—å: $IO_DEPTH"
echo ""

# === –ó–∞–ø—É—Å–∫ –Ω–∞ –≤—Å–µ—Ö –í–ú –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ ===
for ip in "${VMS[@]}"; do
    echo "üöÄ –ó–∞–ø—É—Å–∫ –Ω–∞ $ip..."
    ssh "$USER@$ip" "$CMD" > "fio_output_$ip.log" 2>&1 &
done

wait
echo -e "\n‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã. –õ–æ–≥–∏: fio_output_<IP>.log"